<?php

namespace Sophokles\Dataset;

use Sophokles\Database\FieldType;

/**
 * @property typeText $identifier
 * @property typeText $password
 */
abstract class authDataset extends dataset
{
    protected function abstractInit(): void
    {
        $this->objTableScheme->addColumn('identifier', FieldType::VARCHAR)
            ->length(200)
            ->unique();

        $this->objTableScheme->addColumn('password', FieldType::VARCHAR)
            ->length(256);
    }

    public function login(string $identifier, string $password)
    {
        $this->clearFields();
        $tmpObj = clone $this;
        $tmpObj->getEntriesbyParam(['identifier' => $identifier]);
        do {

            if (password_verify($password, $tmpObj->password)) {

                $arrPVal = [];
                foreach ($this->primaryField as $colName) {
                    $arrPVal[] = $tmpObj->{$colName};
                }

                return $this->getUniqueEntry($tmpObj->uniqueid);
            }

        } while ($tmpObj->moveNext());

        return 0;
    }

    public function save($noSort = false)
    {
        $tmpObj = clone $this;
        $arrPVal = [];
        foreach ($this->primaryField as $colName) {
            $arrPVal[] = $this->{$colName};
        }

        $tmpObj->getEntries($arrPVal);

        if ($this->password !== $tmpObj->password) {
            $crypt = password_hash($this->password, PASSWORD_BCRYPT);
            $this->password = $crypt;
        }

        parent::save($noSort); // TODO: Change the autogenerated stub
    }
}